<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings</title>
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-white text-gray-900 dark:bg-gray-900 dark:text-white min-h-screen transition-colors duration-300">

  <!-- Header -->
  <header class="flex items-center gap-4 bg-[#1e2938] text-white px-6 py-4 shadow-md">
    <button onclick="history.back()" class="text-white hover:text-gray-300 text-2xl">&#8592;</button>
    <h1 class="text-2xl font-semibold" data-i18n="settings">Settings</h1>
  </header>

  <main class="p-8 space-y-8 max-w-xl">

    <!-- Language Selector -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-2" data-i18n="language">Language</h2>
      <select id="languageSelector" class="w-full p-2 rounded bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-white">
        <option value="en">English</option>
        <option value="es">Spanish</option>
        <option value="fr">French</option>
        <option value="de">German</option>
      </select>
    </div>

    <!-- Theme Selector -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-2" data-i18n="theme">Theme</h2>
      <select id="themeSelector" class="w-full p-2 rounded bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-white">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </div>

    <!-- Font Size -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-2" data-i18n="fontSize">Font Size</h2>
      <select id="fontSizeSelector" class="w-full p-2 rounded bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-white">
        <option value="small">Small</option>
        <option value="default">Medium</option>
        <option value="large">Large</option>
      </select>
    </div>

    <!-- Delete Account -->
    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
      <h2 class="text-xl font-semibold mb-4 text-red-500" data-i18n="dangerZone">Danger Zone</h2>
      <button class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded" onclick="confirmDelete()" data-i18n="deleteAccount">Delete Account</button>
    </div>

    <!-- Apply Button -->
    <button onclick="saveSettings()" class="mt-4 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 text-lg rounded transition-all duration-200 ml-auto block">
      Apply
    </button>



  </main>

  <script>
    const translations = {
      en: { settings: "Settings", language: "Language", theme: "Theme", fontSize: "Font Size", dangerZone: "Danger Zone", deleteAccount: "Delete Account" },
      es: { settings: "Configuración", language: "Idioma", theme: "Tema", fontSize: "Tamaño de fuente", dangerZone: "Zona de peligro", deleteAccount: "Eliminar cuenta" },
      fr: { settings: "Paramètres", language: "Langue", theme: "Thème", fontSize: "Taille de la police", dangerZone: "Zone dangereuse", deleteAccount: "Supprimer le compte" },
      de: { settings: "Einstellungen", language: "Sprache", theme: "Thema", fontSize: "Schriftgröße", dangerZone: "Gefahrenzone", deleteAccount: "Konto löschen" }
    };

    function applySettings(theme, fontSize, language) {
      applyTheme(theme);
      applyFontSize(fontSize);
      applyLanguage(language);

      document.getElementById("themeSelector").value = theme;
      document.getElementById("fontSizeSelector").value = fontSize;
      document.getElementById("languageSelector").value = language;
    }

    async function loadUserSettings() {
      const token = localStorage.getItem('token');
      if (!token) return window.location.href = '/login';

      try {
        const response = await fetch('http://localhost:8080/preferences', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) throw new Error("Failed to fetch preferences");

        const data = await response.json();

        const theme = data.theme || 'dark';
        const fontSize = data.fontSize || 'default';
        const language = data.language || 'en';

        localStorage.setItem("theme", theme);
        localStorage.setItem("fontSize", fontSize);
        localStorage.setItem("language", language);

        applySettings(theme, fontSize, language);
      } catch (error) {
        console.error("Error loading user settings:", error);

        const theme = localStorage.getItem("theme") || "dark";
        const fontSize = localStorage.getItem("fontSize") || "default";
        const language = localStorage.getItem("language") || "en";
        applySettings(theme, fontSize, language);
      }
    }

    async function saveSettings() {
      const token = localStorage.getItem("token");
      if (!token) return;

      const theme = document.getElementById("themeSelector").value;
      const fontSize = document.getElementById("fontSizeSelector").value;
      const language = document.getElementById("languageSelector").value;

      const settings = { theme, fontSize, language };

      localStorage.setItem("theme", theme);
      localStorage.setItem("fontSize", fontSize);
      localStorage.setItem("language", language);

      try {
        const res = await fetch("http://localhost:8080/preferences/update", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify(settings)
        });

        if (!res.ok) throw new Error("Failed to save to database");

        console.log("Settings saved successfully");
        applySettings(theme, fontSize, language);
      } catch (error) {
        console.error("Error saving settings:", error);
      }
    }

    function applyFontSize(size) {
      document.body.style.fontSize = size === 'large' ? '18px' : size === 'small' ? '12px' : '16px';
    }

    function applyTheme(theme) {
      const header = document.querySelector("header");
      const cards = document.querySelectorAll("main > div");

      if (theme === "dark") {
        document.body.style.backgroundColor = "#121212";
        document.body.style.color = "#ffffff";
        if (header) header.style.backgroundColor = "#1e2938";
        cards.forEach(c => { c.style.backgroundColor = "#2d3748"; c.style.color = "#ffffff"; });
      } else {
        document.body.style.backgroundColor = "#b6b6b8";
        document.body.style.color = "#000000";
        if (header) header.style.backgroundColor = "#f9f9f9";
        cards.forEach(c => { c.style.backgroundColor = "#f9f9f9"; c.style.color = "#000000"; });
      }
    }

    function applyLanguage(language) {
      const textElements = document.querySelectorAll("[data-i18n]");
      textElements.forEach(el => {
        const key = el.getAttribute("data-i18n");
        el.textContent = translations[language][key] || key;
      });
    }

    function confirmDelete() {
      if (confirm("Are you sure you want to delete your account? This cannot be undone.")) {
        console.log("Account deleted (not implemented)");
      }
    }


    window.onload = loadUserSettings;
  </script>

<script>
  const theme = localStorage.getItem("theme") || "dark";
  const fontSize = localStorage.getItem("fontSize") || "default";
  const language = localStorage.getItem("language") || "en";

  document.documentElement.style.fontSize = fontSize === 'large' ? '18px' : fontSize === 'small' ? '12px' : '16px';
  if (theme === "dark") {
    document.documentElement.classList.add("dark");
    document.body.style.backgroundColor = "#121212";
    document.body.style.color = "#ffffff";
  } else {
    document.documentElement.classList.remove("dark");
    document.body.style.backgroundColor = "#b6b6b8";
    document.body.style.color = "#000000";
  }
</script>

</body>
</html>
