<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Messages</title>
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-900 min-h-screen">
    <div class="antialiased bg-gray-50 dark:bg-gray-900">
        <nav class="bg-white border-b border-gray-200 px-4 py-2.5 dark:bg-gray-800 dark:border-gray-700 fixed left-0 right-0 top-0 z-50">
          <div class="flex flex-wrap justify-between items-center">
            <div class="flex justify-start items-center">
              <button
                data-drawer-target="drawer-navigation"
                data-drawer-toggle="drawer-navigation"
                aria-controls="drawer-navigation"
                class="p-2 mr-2 text-gray-600 rounded-lg cursor-pointer md:hidden hover:text-gray-900 hover:bg-gray-100 focus:bg-gray-100 dark:focus:bg-gray-700 focus:ring-2 focus:ring-gray-100 dark:focus:ring-gray-700 dark:text-gray-400 dark:hover:bg-gray-700 dark:hover:text-white"
              >
                <svg
                  aria-hidden="true"
                  class="w-6 h-6"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    fill-rule="evenodd"
                    d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <svg
                  aria-hidden="true"
                  class="hidden w-6 h-6"
                  fill="currentColor"
                  viewBox="0 0 20 20"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    fill-rule="evenodd"
                    d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                    clip-rule="evenodd"
                  ></path>
                </svg>
                <span class="sr-only">Toggle sidebar</span>
              </button>
              <a href="" class="flex items-center justify-between mr-4">
                <img
                  src="Images/graduating-student.png"
                  class="mr-3 h-8"
                  alt="Logo"
                />
                <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">SADAS</span>
              </a>
              <form action="#" method="GET" class="hidden md:block md:pl-2">
                <label for="topbar-search" class="sr-only">Search</label>
                <div class="relative md:w-64 md:w-96">
                  <div
                    class="flex absolute inset-y-0 left-0 items-center pl-3 pointer-events-none"
                  >
                    <svg
                      class="w-5 h-5 text-gray-500 dark:text-gray-400"
                      fill="currentColor"
                      viewBox="0 0 20 20"
                      xmlns="http://www.w3.org/2000/svg"
                    >
                      <path
                        fill-rule="evenodd"
                        clip-rule="evenodd"
                        d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"
                      ></path>
                    </svg>
                  </div>
                  <input
                    type="text"
                    name="email"
                    id="topbar-search"
                    class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                    placeholder="Search"
                  />
                </div>
              </form>
            </div>
            <div class="flex items-center lg:order-2">
              <button
                type="button"
                data-drawer-toggle="drawer-navigation"
                aria-controls="drawer-navigation"
                class="p-2 mr-1 text-gray-500 rounded-lg md:hidden hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600"
              >
                <span class="sr-only">Toggle search</span>
                <svg aria-hidden="true" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                  <path clip-rule="evenodd" fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"></path>
                </svg>
              </button>
              <!-- Notifications -->
                <button
                type="button"
                data-dropdown-toggle="notification-dropdown"
                class="p-2 mr-1 text-gray-500 rounded-lg hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-700 focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600 relative"
                >
                <span class="sr-only">View notifications</span>
                <!-- Bell icon -->
                <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
                  <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M12 5.365V3m0 2.365a5.338 5.338 0 0 1 5.133 5.368v1.8c0 2.386 1.867 2.982 1.867 4.175 0 .593 0 1.292-.538 1.292H5.538C5 18 5 17.301 5 16.708c0-1.193 1.867-1.789 1.867-4.175v-1.8A5.338 5.338 0 0 1 12 5.365ZM8.733 18c.094.852.306 1.54.944 2.112a3.48 3.48 0 0 0 4.646 0c.638-.572 1.236-1.26 1.33-2.112h-6.92Z"/>
                </svg>
                <!-- Notification Bubble -->
                <span id="notification-bubble" class="absolute top-0 right-0 inline-flex items-center justify-center w-5 h-5 bg-red-500 text-white text-xs font-bold rounded-full" style="display: none;">3</span>
                </button>
                <!-- Dropdown menu -->
                <div
                class="hidden overflow-hidden z-50 my-4 max-w-sm text-base list-none rounded-xl shadow-lg bg-[#101828] text-white border-[5px] border-[#1e2533]"
                id="notification-dropdown">
                <div class="block py-2 px-4 text-base font-medium text-center text-white">
                  Notifications
                </div>
                <div id="notification-list" class="max-h-60 overflow-y-auto text-white">
                  <!-- Notifications will appear here -->
                </div>
                <div class="py-2 px-4 text-center">
                  <button id="clear-all-btn" class="text-red-400 hover:text-red-600">
                    Clear All
                  </button>
                </div>
                </div>
              <!-- avatar --> 
              <button
                type="button"
                class="flex mx-3 text-sm bg-gray-800 rounded-full md:mr-0 focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600"
                id="user-menu-button"
                aria-expanded="false"
                data-dropdown-toggle="dropdown"
              >
                <span class="sr-only">Open user menu</span>
                <img
                  id="user-avatar"
                  class="w-8 h-8 rounded-full"
                  src="Images/spongebob-avatar.jpeg"
                  alt="user photo"
                />
              </button>
              <!-- Dropdown menu -->
               <div
               class="hidden z-50 my-4 w-56 text-base list-none bg-white rounded divide-y divide-gray-100 shadow dark:bg-gray-700 dark:divide-gray-600 rounded-xl"
               id="dropdown"
               >
               <div class="py-3 px-4">
                 <span
                   id="user-name"
                   class="block text-sm font-semibold text-gray-900 dark:text-white"
                   >Loading...</span
                 >
                 <span
                   id="user-email"
                   class="block text-sm text-gray-900 truncate dark:text-white"
                   >Loading...</span
                 >
               </div>
               <ul class="py-1 text-gray-700 dark:text-gray-300" aria-labelledby="dropdown">
                 <li>
                   <a
                   href="profile.html" 
                     class="block py-2 px-4 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-400 dark:hover:text-white"
                     >Profile</a
                   >
                 </li>
                 <li>
                   <a
                     href="settings.html"
                     class="block py-2 px-4 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-400 dark:hover:text-white"
                     >Settings</a
                   >
                 </li>
               </ul>
              
               <ul class="py-1 text-gray-700 dark:text-gray-300" aria-labelledby="dropdown">
                 <li>
                   <a
                     href="#"
                     id="logoutButton"
                     class="block py-2 px-4 text-sm hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white"
                     >Sign Out</a
                   >
                 </li>
               </ul>
               </div>
            </div>
          </div>
        </nav>
        <div class="flex h-screen bg-gray-100 dark:bg-gray-900">
                   <!-- Sidebar -->
<aside
class="fixed top-0 left-0 z-40 w-64 h-screen pt-14 transition-transform bg-white border-r border-gray-200 dark:bg-gray-800 dark:border-gray-700"
aria-label="Sidenav"
id="drawer-navigation"
>
<div class="overflow-y-auto py-5 px-3 h-full bg-white dark:bg-gray-800">
  <form action="#" method="GET" class="md:hidden mb-2">
    <label for="sidebar-search" class="sr-only">Search</label>
    <div class="relative">
      <div class="flex absolute inset-y-0 left-0 items-center pl-3 pointer-events-none">
        <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" clip-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z"></path>
        </svg>
      </div>
      <input
        type="text"
        name="search"
        id="sidebar-search"
        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full pl-10 p-2 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
        placeholder="Search"
      />
    </div>
  </form>
  <ul class="space-y-2">
    <li>
      <a href="dashboard.html" class="flex items-center p-2 text-base font-medium text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m4 12 8-8 8 8M6 10.5V19a1 1 0 0 0 1 1h3v-3a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1v3h3a1 1 0 0 0 1-1v-8.5"/>
        </svg>
        <span class="ml-3">Overview</span>
      </a>
    </li>
    <li>
      <a href="calendar.html" class="flex items-center p-2 w-full text-base font-medium text-gray-900 rounded-lg transition duration-75 group hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700">
        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 10h16m-8-3V4M7 7V4m10 3V4M5 20h14a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1H5a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1Zm3-7h.01v.01H8V13Zm4 0h.01v.01H12V13Zm4 0h.01v.01H16V13Zm-8 4h.01v.01H8V17Zm4 0h.01v.01H12V17Zm4 0h.01v.01H16V17Z"/>
        </svg>
        <span class="flex-1 ml-3 text-left whitespace-nowrap">Calendar</span>
      </a>
    </li>
    <li>
      <a href="#.html" class="flex items-center p-2 w-full text-base font-medium text-gray-900 rounded-lg transition duration-75 group hover:bg-gray-100 dark:text-white dark:hover:bg-gray-700">
        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 6H4a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V7a1 1 0 0 0-1-1Zm7 11-6-2V9l6-2v10Z"/>
        </svg>
        <span class="flex-1 ml-3 text-left whitespace-nowrap">Video Chat</span>
      </a>
    </li>
    <li>
      <a href="messaging.html" class="flex items-center p-2 text-base font-medium text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17h6l3 3v-3h2V9h-2M4 4h11v8H9l-3 3v-3H4V4Z"/>
        </svg>
        <span class="flex-1 ml-3 whitespace-nowrap">Messages</span>
        <span class="inline-flex justify-center items-center w-5 h-5 text-xs font-semibold rounded-full text-primary-800 bg-primary-100 dark:bg-primary-200 dark:text-primary-800">
          
        </span>
      </a>
    </li>
  </ul>
  <ul class="pt-5 mt-5 space-y-2 border-t border-gray-200 dark:border-gray-700">

    <li>
      <a href="settings.html" class="flex items-center p-2 text-base font-medium text-gray-900 rounded-lg transition duration-75 hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-white group">
        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
          <path stroke="currentColor" stroke-linecap="square" stroke-linejoin="round" stroke-width="2" d="M10 19H5a1 1 0 0 1-1-1v-1a3 3 0 0 1 3-3h2m10 1a3 3 0 0 1-3 3m3-3a3 3 0 0 0-3-3m3 3h1m-4 3a3 3 0 0 1-3-3m3 3v1m-3-4a3 3 0 0 1 3-3m-3 3h-1m4-3v-1m-2.121 1.879-.707-.707m5.656 5.656-.707-.707m-4.242 0-.707.707m5.656-5.656-.707.707M12 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
        </svg>
        <span class="ml-3">Settings</span>
      </a>
    </li>
    
    <li>
      <a href="#" class="flex items-center p-2 text-base font-medium text-gray-900 rounded-lg transition duration-75 hover:bg-gray-100 dark:hover:bg-gray-700 dark:text-white group">
        <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 14v7M5 4.971v9.541c5.6-5.538 8.4 2.64 14-.086v-9.54C13.4 7.61 10.6-.568 5 4.97Z"/>
        </svg>
        <span class="ml-3">Help</span>
      </a>
    </li>
  </ul>
  </div>
</aside>
<!-- End Sidebar -->
          
<!-- Messaging Section -->
<div class="flex-1 flex flex-col ml-64 relative">
  <!-- Header -->
  <header class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Messages</h2>
  </header>

  <!-- Chat List and Chat Area -->
  <div class="flex-1 flex overflow-hidden">
    <!-- Chat List -->
    <aside class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 p-4 relative">
      <div class="overflow-y-auto max-h-[calc(100vh-100px)] pr-2">
        <!-- Search -->
        <div class="mb-4">
          <input
            type="text"
            id="search-friends"
            placeholder="Search for friends"
            class="w-full p-2 mb-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
          />
        </div>

        <!-- Search Results -->
        <ul id="search-results" class="space-y-2 mb-4">
          <!-- Dynamic search results -->
        </ul>

        <!-- Friend Requests Section -->
        <div class="friend-requests-container mt-6 mb-6">
          <h3 class="text-2xl font-bold text-white mb-4">Friend Requests</h3>
          <ul id="friend-requests-list" class="space-y-2 overflow-y-auto max-h-[200px] bg-[#101828] rounded-lg p-0">
            <li class="text-gray-500 dark:text-gray-400 text-sm">No friend requests at the moment.</li>
          </ul>
        </div>

        <!-- Group Chats Section -->
        <div class="group-chats-container mb-6">
          <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4">Group Chats</h3>
          <ul id="group-chats-list" class="space-y-2 overflow-y-auto max-h-[200px] bg-[#101828] rounded-lg p-4">
            <!-- Dynamic list of group chats -->
          </ul>
        </div>

        <!-- Friend List Header and + -->
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-2xl font-bold text-gray-900 dark:text-white">Friend List</h3>
          <button
            id="toggle-group-chat"
            class="w-8 h-8 flex items-center justify-center rounded-full bg-indigo-600 hover:bg-indigo-700 text-white"
            title="Create Group Chat"
          >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
          </button>
        </div>

        <!-- Friend List -->
        <ul id="friend-list" class="space-y-2 overflow-y-auto max-h-[400px]">
          <!-- Friends go here -->
        </ul>
      </div>

      <!-- Group Chat Creation Form  -->
      <div id="group-chat-form" class="fixed z-50 bg-white dark:bg-gray-900 shadow-xl p-4 rounded-lg hidden w-80">

        <input
          type="text"
          id="group-name"
          placeholder="Group Name"
          class="w-full p-2 mb-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        />
        <textarea
          id="group-description"
          placeholder="Description (optional)"
          class="w-full p-2 mb-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        ></textarea>

        <div class="search-container">
          <input
            type="text"
            id="friend-search"
            class="w-full p-2 mb-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
            placeholder="Search for friends..."
          />
        </div>

        <div id="friend-list-container" class="mb-4 max-h-[150px] overflow-y-auto">
          <!-- Dynamically populated list of friends to invite -->
        </div>

        <div class="invited-friends-container bg-[#101828] p-4 rounded-lg max-h-[150px] overflow-y-auto">
          <h3 class="text-white font-bold mb-2">Invited Friends</h3>
          <ul id="invited-friends-list" class="list-none"></ul>
        </div>

        <button
          id="create-group-btn"
          class="w-full p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 mt-2"
        >
          Create
        </button>
      </div>
    </aside>

    <!-- Chat Area -->
    <div class="flex-1 flex flex-col bg-white dark:bg-gray-800">
      <!-- Chat Header -->
      <div class="border-b border-gray-200 dark:border-gray-700 p-4">
        <div id="chat-header" class="flex items-center hidden">
          <img
            id="chat-avatar"
            src="Images/minion-icon.jpg"
            alt="Friend Avatar"
            class="w-8 h-8 rounded-full mr-3"
          />
          <div>
            <p id="chat-friend-name" class="text-lg font-semibold text-gray-900 dark:text-white"></p>
            <p id="chat-members" class="text-sm text-gray-300"></p>
            <p id="chat-status" class="text-xs text-gray-500 dark:text-gray-400"></p>
          </div>
        </div>
      </div>

      <!-- Chat Messages -->
      <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-4">
        <!-- Messages appear here -->
      </div>

      <!-- Message Input -->
      <div class="border-t border-gray-200 dark:border-gray-700 p-4">
        <div class="flex items-center">
          <input
            id="message-input"
            type="text"
            placeholder="Type a message..."
            class="flex-1 p-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
          />
          <button id="send-message" class="ml-2 p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"
              ></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
const toggleBtn = document.getElementById('toggle-group-chat');
const form = document.getElementById('group-chat-form');

toggleBtn.addEventListener('click', () => {
  if (form.classList.contains('hidden')) {
    const rect = toggleBtn.getBoundingClientRect();
    const formWidth = form.offsetWidth;
    const formHeight = form.scrollHeight;
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;

    let top = rect.top + window.scrollY;
    let left = rect.right + 10;

    if (left + formWidth > windowWidth) {
      left = windowWidth - formWidth - 10; 
    }

    if (top + formHeight > windowHeight) {
      top = windowHeight - formHeight - 10; 
    }

    if (top < 0) {
      top = 10; 
    }
    form.style.top = `${top}px`;
    form.style.left = `${left}px`;
    form.style.transform = 'translateY(0)'; 

    form.classList.remove('hidden');
  } else {
    form.classList.add('hidden');
  }
});

window.addEventListener('resize', () => {
  if (!form.classList.contains('hidden')) {
    const rect = toggleBtn.getBoundingClientRect();
    const formWidth = form.offsetWidth;
    const formHeight = form.scrollHeight;
    const windowWidth = window.innerWidth;
    const windowHeight = window.innerHeight;

    let top = rect.top + window.scrollY;
    let left = rect.right + 10;
    if (left + formWidth > windowWidth) {
      left = windowWidth - formWidth - 10;
    }
    if (top + formHeight > windowHeight) {
      top = windowHeight - formHeight - 10;
    }
    if (top < 0) {
      top = 10;
    }

    form.style.top = `${top}px`;
    form.style.left = `${left}px`;
  }
});
</script>


<script>
  async function getUserData() {
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';  
    return;
  }

  try {
    const response = await fetch('http://localhost:8080/dashboard', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      }
    });

    if (!response.ok) throw new Error('Failed to fetch user data');
    
    const user = await response.json();

    if (user && user.userid) {
      localStorage.setItem('userID', user.userid);
    } else {
      console.error('User ID is missing from the response', user);
    }

    document.getElementById("user-name").textContent = user.username || "Unknown User";
    document.getElementById("user-email").textContent = user.email || "user@example.com";
    const avatar = document.getElementById("user-avatar");
        if (user.profilePicUrl) {
            avatar.src = user.profilePicUrl;
        }
  } catch (error) {
    console.error('Error fetching user data:', error);
  }
}


  document.getElementById("logoutButton").addEventListener("click", async function (event) {
    event.preventDefault(); 

    try {
      const token = localStorage.getItem("token");

      const response = await fetch("http://localhost:8080/logout", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`, 
        },
      });

      if (response.ok) {
        localStorage.removeItem("token");
        localStorage.removeItem("userID");  
        sessionStorage.removeItem("token");

        window.location.href = "login.html"; 
      } else {
        console.error("Logout failed:", await response.json());
      }
    } catch (error) {
      console.error("Error during logout:", error);
    }
  });

  //FRIENDS
  async function fetchFriendRequests() {
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';  
    return;
  }

  try {
    console.log("Fetching friend requests...");
    const response = await fetch('http://localhost:8080/friend-requests', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      }
    });

    if (!response.ok) throw new Error('Failed to fetch friend requests');
    
    const requests = await response.json();

    const friendRequestsContainer = document.querySelector('.friend-requests-container');
    const friendRequestsList = document.getElementById('friend-requests-list');
    
    if (!friendRequestsList) {
      console.error("Friend requests list element not found");
      return;
    }

    friendRequestsList.innerHTML = '';
    
    if (requests.length === 0) {
      friendRequestsList.innerHTML = '<li class="text-gray-500 dark:text-gray-400 text-sm">No friend requests at the moment.</li>';
      friendRequestsContainer.style.display = 'none'; // Hide section
    } else {
      // If friend requests, display them 
      friendRequestsContainer.style.display = 'block';
      
      requests.forEach(request => {
        const listItem = document.createElement('li');
        listItem.classList.add('flex', 'justify-between', 'items-center', 'bg-[#101828]', 'w-full', 'py-2', 'px-3', 'mb-2'); // Reduced bottom padding

        listItem.innerHTML = `
          <span class="font-semibold text-white w-auto">${request.senderUsername}</span> <!-- Requester's name -->
          <div class="flex space-x-2"> <!-- Button container aligned to the right -->
            <button class="accept-btn text-2xl text-green-500 hover:text-green-600 cursor-pointer" data-id="${request.requestID}">
              <i class="fas fa-check"></i> <!-- Font Awesome checkmark -->
            </button>
            <button class="decline-btn text-2xl text-red-500 hover:text-red-600 cursor-pointer" data-id="${request.requestID}">
              <i class="fas fa-times"></i> <!-- Font Awesome X -->
            </button>
          </div>
        `;

        friendRequestsList.appendChild(listItem);

        listItem.querySelector('.accept-btn').addEventListener('click', async () => {
          await handleAcceptRequest(request.requestID, request.creatorID);
        });

        listItem.querySelector('.decline-btn').addEventListener('click', async () => {
          await handleDeclineRequest(request.requestID, request.creatorID);
          fetchFriendRequests();
        });
      });
    }
  } catch (error) {
    console.error('Error fetching friend requests:', error);
  }
}

async function handleAcceptRequest(requestId, creatorID) {
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';  
    return;
  }

  try {
    const response = await fetch('http://localhost:8080/friend-request/accept', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ creatorID })
    });

    const result = await response.json();

    if (response.ok) {
      alert('Friend request accepted');
      await fetchFriendRequests();
      await fetchFriendsList();
 
    } else {
      console.error(result.message || 'Error accepting friend request');
    }
  } catch (error) {
    console.error('Error handling accept request:', error);
  }
}

async function handleDeclineRequest(requestId, creatorID) {
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';  
    return;
  }

  try {
    const response = await fetch('http://localhost:8080/friend-request/decline', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ creatorID })
    });

    const result = await response.json();

    if (response.ok) {
      alert('Friend request declined');
      await fetchFriendRequests();
      await fetchFriendsList();
   
    } else {
      console.error(result.message || 'Error declining friend request');
    }
  } catch (error) {
    console.error('Error handling decline request:', error);
  }
}

async function fetchFriendsList() {
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';  
    return;
  }

  try {
    console.log("Fetching friends list...");
    const response = await fetch('http://localhost:8080/friends-list', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      }
    });

    if (!response.ok) throw new Error('Failed to fetch friends list');
    
    const friends = await response.json();

    const friendList = document.getElementById('friend-list');
    if (!friendList) {
      console.error("Friend list element not found");
      return;
    }
    
    friendList.innerHTML = ''; 
    
    if (friends.length === 0) {
      friendList.innerHTML = '<li class="text-gray-500 dark:text-gray-400 text-sm">You have no friends yet.</li>';
    } else {
      friends.forEach(friend => {
        const listItem = document.createElement('li');
        listItem.classList.add('p-2', 'bg-gray-200', 'rounded', 'flex', 'justify-between', 'items-center');
        listItem.innerHTML = `
          <div class="flex items-center justify-between w-full">
            <span class="truncate max-w-[120px] text-gray-700">${friend.username}</span>
            <div class="flex items-center space-x-2 ml-4 shrink-0">
              <button class="open-chat-btn text-blue-500 hover:text-blue-700" data-id="${friend.friendID}">
                <i class="fas fa-comment-alt"></i>
              </button>
              <button class="remove-friend-btn text-red-500 hover:text-red-700" data-id="${friend.friendID}">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        `;
        friendList.appendChild(listItem);

        listItem.querySelector('.remove-friend-btn').addEventListener('click', async () => {
          const confirmation = window.confirm(`Are you sure you want to remove ${friend.username} from your friends?`);
          if (confirmation) {
            await removeFriend(friend.friendID);
            listItem.remove(); 
          }
        });
        listItem.querySelector('.open-chat-btn').addEventListener('click', async () => {
          openChat(friend);
        });
      });
    }
  } catch (error) {
    console.error('Error fetching friends list:', error);
  }
}

//CONVERSATIONS
function openChat(friend) {
  const chatHeader = document.getElementById('chat-header');
  const chatFriendName = document.getElementById('chat-friend-name');
  const chatAvatar = document.getElementById('chat-avatar');
  const memberList = document.getElementById('chat-members');
  memberList.textContent = ''; 
  chatFriendName.textContent = friend.username;
  chatAvatar.src = friend.profilePicUrl || 'Images/minion-icon.jpg';
  chatHeader.classList.remove('hidden');
  localStorage.setItem('currentChatID', friend.friendID);
  localStorage.removeItem('currentGroupID'); 
  loadChatHistory(friend.friendID);
}


async function loadChatHistory(friendID) {
  try {
    const token = localStorage.getItem('token'); 
    const response = await fetch(`http://localhost:8080/messages/${friendID}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch messages');
    }

    const messages = await response.json();
    
    // Debugging by checking message array
    const chatMessages = messages[0]; 
    console.log(chatMessages); 

    displayMessages(chatMessages); 
  } catch (error) {
    console.error(error);
    alert('Error loading messages');
  }
}

function displayMessages(messages) {
  const messagesContainer = document.getElementById('messages');
  messagesContainer.innerHTML = '';

  if (!Array.isArray(messages) || messages.length === 0) {
    messagesContainer.innerHTML = '<p style="color: white; text-align: center; font-size: 24px;">No messages found</p>';
    return;
  }

  let lastMessageDate = null;
  const currentChatID = localStorage.getItem('currentChatID'); // ID of the other person

  messages.forEach((message) => {
    if (!message || !message.created_at || !message.content) {
      console.error('Invalid message data', message);
      return;
    }

    const messageElement = document.createElement('div');

    // Format time and date
    const messageTime = new Date(message.created_at);
    const formattedTime = messageTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const formattedDate = messageTime.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    // Show date if different from last message
    if (lastMessageDate !== formattedDate) {
      const dateElement = document.createElement('div');
      dateElement.innerHTML = `
        <div style="text-align: center; margin: 10px 0; font-weight: bold; color: #888;">
          ${formattedDate}
        </div>
      `;
      messagesContainer.appendChild(dateElement);
      lastMessageDate = formattedDate;
    }

    const isSender = message.senderID !== parseInt(currentChatID);

    messageElement.innerHTML = `
      <div style="display: flex; flex-direction: ${isSender ? 'row-reverse' : 'row'}; margin-bottom: 10px; align-items: flex-end;">
        <!-- Sender's Name (hidden for one-on-one chats) -->
        <div style="display: none; font-weight: bold; margin-${isSender ? 'left' : 'right'}: 10px; font-size: 0.9rem; color: ${isSender ? '#ffffff' : '#555'};">
          ${message.senderName || 'Unknown Sender'}
        </div>

        <!-- Message Bubble -->
        <div style="
          background-color: ${isSender ? '#007bff' : '#e5e5e5'};
          color: ${isSender ? 'white' : 'black'};
          padding: 10px;
          border-radius: 15px;
          max-width: 75%;
          word-wrap: break-word;
          display: flex;
          flex-direction: column;
          justify-content: flex-end;
        ">
          <p style="margin-top: 0.5rem; margin-bottom: 10px;">${message.content}</p>

          <div style="font-size: 0.8rem; color: ${isSender ? '#ffffff' : '#888'}; text-align: right; margin-top: auto;">
            ${formattedTime}
          </div>
        </div>
      </div>
    `;

    messagesContainer.appendChild(messageElement);
  });

  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Send a message to the friend
async function sendMessage(receiverID, content) {
  try {
    const token = localStorage.getItem('token');

    const messagePayload = {
      receiverID: receiverID,
      content: content,
    };

    const response = await fetch('http://localhost:8080/message/send', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(messagePayload),
    });

    if (!response.ok) {
      throw new Error('Failed to send message');
    }

    const data = await response.json();
    alert(data.message); 

    const currentFriendID = localStorage.getItem('currentChatID');
    loadChatHistory(currentFriendID); 
  } catch (error) {
    console.error(error);
    alert('Error sending message');
  }
}


const sendButton = document.getElementById('send-message');
sendButton.addEventListener('click', () => {
  const messageInput = document.getElementById('message-input');
  const content = messageInput.value.trim();

  const currentGroupID = localStorage.getItem('currentGroupID');
  const currentChatID = localStorage.getItem('currentChatID');

  if (content) {
    if (currentGroupID) {
      sendGroupMessage(currentGroupID, content);  // Group chat message
    } else if (currentChatID) {
      sendMessage(currentChatID, content);  // One-on-one chat message
    } else {
      alert('No active chat found!');
    }

    messageInput.value = ''; 
  } else {
    alert('Please enter a message');
  }
});


async function removeFriend(friendID) {
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';  
    return;
  }

  try {
    const response = await fetch('http://localhost:8080/friend/remove', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ friendID }),
    });

    const data = await response.json();
    if (response.ok) {
      console.log(data.message);
    } else {
      console.error(data.message);
    }
  } catch (error) {
    console.error('Error removing friend:', error);
  }
}


async function searchForFriends() {
  const searchTerm = document.getElementById('search-friends').value.trim();
  const token = localStorage.getItem('token');

  if (!token) {
    window.location.href = '/login';  
    return;
  }

  try {
    if (searchTerm.length > 0) {
      const response = await fetch(`http://localhost:8080/friends-search?q=${encodeURIComponent(searchTerm)}`, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json',
        }
      });

      if (!response.ok) throw new Error('Failed to search for friends');

      const users = await response.json();
      displaySearchResults(users);
    } else {
      document.getElementById('search-results').innerHTML = '';
    }
  } catch (error) {
    console.error('Error searching for friends:', error);
  }
}

function displaySearchResults(users) {
  const resultsContainer = document.getElementById('search-results');
  resultsContainer.innerHTML = ''; 

  resultsContainer.classList.add('absolute', 'top-[60px]', 'left-0', 'z-10', 'bg-white', 'dark:bg-gray-900', 'shadow-lg', 'rounded-lg', 'w-full');
  if (users.length === 0) {
    resultsContainer.innerHTML = '<li class="text-gray-500 dark:text-gray-400 text-sm">No users found.</li>';
  } else {
    users.slice(0, 5).forEach(user => { 
      const listItem = document.createElement('li');
      listItem.classList.add('p-2', 'bg-[#101828]', 'text-white', 'rounded', 'flex', 'justify-between', 'items-center', 'mb-4', 'max-w-[250px]');
      listItem.innerHTML = `
        <span class="font-semibold truncate">${user.username}</span>  <!-- Truncate long names -->
        <button class="add-btn bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600" data-id="${user.UserID}">
          Add
        </button>
      `;

      resultsContainer.appendChild(listItem);

      listItem.querySelector('.add-btn').addEventListener('click', async function() {
        console.log("Attempting to send friend request to UserID:", user.UserID);
        if (!user.UserID) {
          console.error("Error: UserID is undefined or null.");
          return;
        }
        await sendFriendRequest(user.UserID);
      });
    });

    if (users.length >= 5) {
      resultsContainer.classList.add('overflow-y-auto', 'max-h-[300px]');
    }
  }
}

async function sendFriendRequest(userId) {
  if (!userId) {
    console.error("sendFriendRequest error: userId is missing or null.");
    return;
  }

  const token = localStorage.getItem('token');

  if (!token) {
    window.location.href = '/login';
    return;
  }

  console.log("Sending request with receiverID:", userId); // Debugging

  try {
    const response = await fetch(`http://localhost:8080/friend-request/send`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ receiverID: userId })
    });

    if (!response.ok) throw new Error('Failed to send friend request');

    alert('Friend request sent successfully!');  
    fetchFriendRequests(); 
  } catch (error) {
    console.error('Error sending friend request:', error);
  }
}


document.getElementById('search-friends').addEventListener('input', searchForFriends);


// GROUPCHAT STUFF
async function fetchFriendsForSelection() {
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';  
    return;
  }

  try {
    console.log("Fetching friends list for selection...");
    const response = await fetch('http://localhost:8080/friends-list', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      }
    });

    if (!response.ok) throw new Error('Failed to fetch friends list for selection');
    
    const friends = await response.json();

    const friendListContainer = document.getElementById('friend-list-container');
    if (!friendListContainer) {
      console.error("Friend list container not found");
      return;
    }

    friendListContainer.style.display = 'none';

    friendListContainer.innerHTML = '';

    if (friends.length === 0) {
      friendListContainer.innerHTML = '<p class="text-gray-500">You have no friends to invite.</p>';
    } else {
      friends.forEach(friend => {
        const friendItem = document.createElement('div');
        friendItem.classList.add('friend-item', 'mb-2', 'flex', 'items-center');
        friendItem.innerHTML = `
          <label class="flex items-center bg-[#101828] text-white rounded-full p-2 mr-2">
            <input type="checkbox" id="friend-${friend.friendID}" class="friend-checkbox mr-2" data-id="${friend.friendID}">
            <span class="font-semibold truncate">${friend.username}</span>
          </label>
        `;
        friendListContainer.appendChild(friendItem);
      });
    }
  } catch (error) {
    console.error('Error fetching friends list for selection:', error);
  }
}

document.getElementById('friend-list-container').addEventListener('change', (e) => {
  if (e.target && e.target.classList.contains('friend-checkbox')) {
    const friendID = e.target.getAttribute('data-id');
    const friendName = e.target.nextElementSibling.textContent.trim(); 
    handleFriendSelection(friendID, friendName, e.target.checked);
  }
});


function handleFriendSelection(friendID, friendName, isChecked) {
  const invitedFriendsList = document.getElementById('invited-friends-list');
  const selectedFriends = Array.from(invitedFriendsList.children).map(item => item.dataset.id);
  
  if (isChecked && !selectedFriends.includes(friendID)) {
    const listItem = document.createElement('li');
    listItem.classList.add('flex', 'items-center', 'mb-2');
    listItem.dataset.id = friendID;
    listItem.innerHTML = `
      <span class="text-white">${friendName}</span>
      <button class="remove-btn text-red-500 ml-2" onclick="removeInvitedFriend(this, ${friendID})">X</button>
    `;
    invitedFriendsList.appendChild(listItem);
  } else if (!isChecked) {
    const listItem = document.querySelector(`#invited-friends-list li[data-id="${friendID}"]`);
    if (listItem) listItem.remove();
  }
}

// Remove friend from the invited list
function removeInvitedFriend(button, friendID) {
  const checkbox = document.querySelector(`#friend-${friendID}`);
  if (checkbox) checkbox.checked = false;
  
  button.closest('li').remove();
}

document.getElementById('friend-search').addEventListener('input', (e) => {
  const searchTerm = e.target.value.toLowerCase();
  const friendItems = document.querySelectorAll('.friend-item');
  const friendListContainer = document.getElementById('friend-list-container');

  if (searchTerm.trim()) {
    friendListContainer.style.display = 'block';
  } else {
    friendListContainer.style.display = 'none';
  }

  friendItems.forEach(item => {
    const friendName = item.querySelector('label span').textContent.toLowerCase();
    if (friendName.includes(searchTerm)) {
      item.style.display = '';
    } else {
      item.style.display = 'none';
    }
  });
});


async function createGroupChat() {
  const channelName = document.getElementById('group-name').value;
  const description = document.getElementById('group-description').value;
  const selectedFriends = Array.from(document.querySelectorAll('#invited-friends-list li')).map(item => item.dataset.id);

  console.log('Selected friends:', selectedFriends); 

  if (!channelName || selectedFriends.length === 0) {
    alert('Please provide a group name and select at least one friend to invite.');
    return;
  }

  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';
    return;
  }

  try {
    console.log("Creating group chat...");
    const response = await fetch('http://localhost:8080/group/create', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        channelName,
        description,
        invitedFriends: selectedFriends,  
      }),
    });

    if (!response.ok) throw new Error('Failed to create group chat');
    
    const result = await response.json();

    if (result.message === 'Group chat created successfully.') {
      alert('Group chat created successfully!');
      fetchGroupChats()
    } else {
      alert('Failed to create group chat.');
    }
  } catch (error) {
    console.error('Error creating group chat:', error);
  }
}


document.getElementById('create-group-btn').addEventListener('click', createGroupChat);

async function fetchGroupChats() {
  const token = localStorage.getItem('token');
  if (!token) {
    window.location.href = '/login';
    return;
  }

  try {
    const response = await fetch('http://localhost:8080/group/list', {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch group chats');
    }

    const result = await response.json();
    console.log("Fetched group chats:", result);

    const chatList = document.getElementById('group-chats-list');
    const groupChatsContainer = document.querySelector('.group-chats-container');

    if (!chatList) {
      console.error('Group chat list element not found');
      return;
    }

    chatList.innerHTML = '';

    if (!result.groups || result.groups.length === 0) {
      chatList.innerHTML = '<li class="text-gray-500 dark:text-gray-400 text-sm">No group chats found.</li>';
      groupChatsContainer.style.display = 'none'; // Hide if empty
      return;
    }

    groupChatsContainer.style.display = 'block'; // Show if there are chats

    result.groups.forEach(group => {
      const listItem = document.createElement('li');
      listItem.classList.add('flex', 'justify-between', 'items-center', 'bg-[#101828]', 'w-full', 'py-2', 'px-3', 'mb-2', 'rounded');

      listItem.innerHTML = `
        <span class="font-semibold text-white">${group.channel_name}</span>
        <div class="flex space-x-2 ml-auto">
          <button class="open-chat-btn text-xl text-blue-400 hover:text-blue-500 cursor-pointer" data-id="${group.channelID}" title="Open Chat">
            <i class="fa-solid fa-user-group"></i>
          </button>
          <button class="leave-group-btn text-xl text-red-500 hover:text-red-600 cursor-pointer" data-id="${group.channelID}" title="Leave Group">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;

      listItem.querySelector('.open-chat-btn').addEventListener('click', () => {
        openGroupChat(group);
      });

      listItem.querySelector('.leave-group-btn').addEventListener('click', async () => {
        await leaveGroup(group.channelID);
      });

      chatList.appendChild(listItem);
    });

  } catch (error) {
    console.error('Error fetching group chats:', error);
  }
}


function openGroupChat(group) {
  const groupChatName = document.getElementById('chat-header');
  const groupName = document.getElementById('chat-friend-name');
  const chatAvatar = document.getElementById('chat-avatar');
  const memberList = document.getElementById('chat-members'); 
  groupName.textContent = group.channel_name;
  chatAvatar.src = group.avatarUrl || 'Images/yuji-cat.jpg';
  const membersArray = Array.isArray(group.members) ? group.members : [group.members];
  console.log("Group members:", membersArray);
  if (membersArray.length > 0) {
    const names = membersArray.join(', ');
    memberList.innerHTML = `<span style="color: white;">Members: ${names}</span>`;
  } else {
    memberList.textContent = ''; 
  }
  groupChatName.classList.remove('hidden');

  localStorage.setItem('currentGroupID', group.channelID);
  localStorage.removeItem('currentChatID');
  loadGroupChatHistory(group.channelID);
}


async function loadGroupChatHistory(groupID) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:8080/group/messages/${groupID}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch group messages');
    }

    const messages = await response.json();
    displayGroupMessages(messages);  
  } catch (error) {
    console.error(error);
    alert('Error loading messages');
  }
}

async function leaveGroup(channelID) {  
  try {
    const token = localStorage.getItem('token');
    const response = await fetch(`http://localhost:8080/group/leave`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ channelID }),  
    });

    if (!response.ok) {
      throw new Error('Failed to leave group');
    }

    const result = await response.json();
    console.log(result.message);
    alert(result.message);
    fetchGroupChats();  
  } catch (error) {
    console.error(error);
    alert('Error leaving group');
  }
}


function displayGroupMessages(messages) {
  const messagesContainer = document.getElementById('messages');
  messagesContainer.innerHTML = '';

  if (!Array.isArray(messages) || messages.length === 0) {
    messagesContainer.innerHTML = '<p style="color: white; text-align: center; font-size: 24px;">No messages found</p>';
    return;
  }

  let lastMessageDate = null;
  let lastSenderId = null;
  let lastReceiverName = null;
  const currentUserID = parseInt(localStorage.getItem('userID')); 

  messages.reverse().forEach((message) => {
    if (!message || !message.created_at || !message.content || !message.user_id) {
      console.error('Invalid message data', message);
      return;
    }

    const messageElement = document.createElement('div');

    const messageTime = new Date(message.created_at);
    const formattedTime = messageTime.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const formattedDate = messageTime.toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });

    if (lastMessageDate !== formattedDate) {
      const dateElement = document.createElement('div');
      dateElement.innerHTML = `
        <div style="text-align: center; margin: 10px 0; font-weight: bold; color: #888;">
          ${formattedDate}
        </div>
      `;
      messagesContainer.appendChild(dateElement);
      lastMessageDate = formattedDate;
    }

    const isSender = message.user_id === currentUserID;
    const isSameSenderAsLastMessage = message.user_id === lastSenderId;
    const isLatestMessageFromUser = !isSameSenderAsLastMessage;

    const avatarWidth = '40px';

    messageElement.innerHTML = `
      <div style="display: flex; flex-direction: ${isSender ? 'row-reverse' : 'row'}; margin-bottom: 10px; align-items: flex-end;">
        <!-- Receiver's Avatar Placeholder (Only for the latest message from the receiver) -->
        <div style="margin-${isSender ? 'left' : 'right'}: 10px; width: ${isSender ? '0px' : avatarWidth};">
          ${!isSender && isLatestMessageFromUser ? `<img src="${message.senderAvatar || 'Images/spongebob-avatar.jpeg'}" style="border-radius: 50%; width: 30px; height: 30px;">` : ''}
        </div>

        <!-- Message Content and Bubble -->
        <div style="display: flex; flex-direction: column; max-width: 75%; word-wrap: break-word; ${isSender ? 'margin-left: 0;' : 'margin-right: 0;'}">
          <!-- Receiver's Name (Only for the Receiver and not for consecutive messages from the same user) -->
          ${!isSender && message.senderName !== lastReceiverName ? `
            <div style="font-size: 0.9rem; color: white; font-weight: bold; margin-bottom: 5px; margin-left: 10px;">
              ${message.senderName}
            </div>
          ` : ''}

          <div style="
            background-color: ${isSender ? '#007bff' : '#e5e5e5'};
            color: ${isSender ? 'white' : 'black'};
            padding: 10px;
            border-radius: 15px;
            word-wrap: break-word;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
          ">
            <!-- Message Content -->
            <p style="margin: 0;">${message.content}</p>

            <!-- Time -->
            <div style="font-size: 0.75rem; color: ${isSender ? '#ddd' : '#888'}; text-align: right; margin-top: 5px; white-space: nowrap;">
              ${formattedTime}
            </div>
          </div>
        </div>
      </div>
    `;

    messagesContainer.appendChild(messageElement);
    lastSenderId = message.user_id;
    lastReceiverName = message.senderName;
  });

  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}


async function sendGroupMessage(groupID, content) {
  try {
    const token = localStorage.getItem('token');

    const messagePayload = {
      channelID: groupID,  
      content: content,
    };

    const response = await fetch('http://localhost:8080/group-message/send', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(messagePayload),
    });

    if (!response.ok) {
      throw new Error('Failed to send message');
    }

    const data = await response.json();
    alert(data.message);

    loadGroupChatHistory(groupID); 
  } catch (error) {
    console.error('Error:', error);
    alert('Error sending message');
  }
}

// Function to display notifications
function displayNotifications(notifications) {
  const notificationList = document.getElementById('notification-list');
  const notificationBadge = document.getElementById('notification-bubble'); // Notification bubble
  notificationList.innerHTML = ''; 

  const unreadNotifications = notifications.data.filter(notification => !notification.read); 

  if (unreadNotifications.length === 0) {
    notificationList.innerHTML = '<p class="text-center text-white py-1">None</p>';
    notificationBadge.style.display = 'none'; 
    return;
  }

  notificationBadge.style.display = 'inline-flex'; 
  notificationBadge.textContent = unreadNotifications.length;
  const notificationIDs = [];

  unreadNotifications.forEach((notification) => {
    const notificationItem = document.createElement('div');
    notificationItem.classList.add(
      'notification-item',
      'p-2',
      'mb-2',
      'border-b',
      'border-gray-200',
      'dark:border-gray-600',
      'text-white',
      'flex', 
      'items-center' 
    );
    notificationItem.style.backgroundColor = '#101828';

    const content = document.createElement('div');
    content.classList.add('content');
    content.textContent = notification.content;

    const markReadButton = document.createElement('button');
    markReadButton.classList.add('text-blue-500', 'hover:text-blue-700', 'ml-4'); 
    markReadButton.textContent = 'Mark Read';
    
    markReadButton.onclick = () => markNotificationAsRead(notification.id, notificationItem, notifications.data);

    notificationItem.appendChild(content);
    notificationItem.appendChild(markReadButton);

    notificationList.appendChild(notificationItem);

    notificationIDs.push(notification.id);
  });

  document.getElementById('clear-all-btn').onclick = () => clearAllNotifications(notificationIDs);
}

// Function to mark a notification as read
async function markNotificationAsRead(notificationID, notificationElement, allNotifications) {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('http://localhost:8080/notification/mark-read', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ notificationID }),
    });

    if (!response.ok) {
      throw new Error('Failed to mark notification as read');
    }

    const data = await response.json();
    alert(data.message); 

    notificationElement.remove();

    const unreadNotifications = allNotifications.filter(notification => !notification.read);
    const notificationBadge = document.getElementById('notification-bubble');
    
    notificationBadge.textContent = unreadNotifications.length;

    if (unreadNotifications.length === 0) {
      notificationBadge.style.display = 'none';
    }

  } catch (error) {
    console.error('Error marking notification as read:', error);
    alert('Error marking notification as read');
  }
}

// Function to clear all notifications
async function clearAllNotifications() {
  try {
    const token = localStorage.getItem('token');
    const userID = localStorage.getItem('userID'); 

    const response = await fetch('http://localhost:8080/notifications/clear-all', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ userID }),
    });

    if (!response.ok) {
      throw new Error('Failed to clear notifications');
    }

    const data = await response.json();
    alert(data.message); 

    document.getElementById('notification-list').innerHTML = '<p>No notifications</p>';
  } catch (error) {
    console.error('Error clearing notifications:', error);
    alert('Error clearing notifications');
  }
}

document.getElementById('clear-all-btn').addEventListener('click', clearAllNotifications);


async function fetchNotifications() {
  try {
    const token = localStorage.getItem('token');
    const response = await fetch('http://localhost:8080/notifications', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      throw new Error('Failed to fetch notifications');
    }

    const notifications = await response.json();
    console.log('Notifications:', notifications); 
    displayNotifications(notifications);
  } catch (error) {
    console.error('Error fetching notifications:', error);
  }
}


window.onload = function() {
  fetchFriendRequests();
  fetchFriendsList();
  fetchFriendsForSelection();
  fetchGroupChats();
  const notificationDropdown = document.getElementById('notification-dropdown');
  notificationDropdown.classList.add('hidden');
  fetchNotifications();
  getUserData();
};

</script>


  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
</body>
</html>