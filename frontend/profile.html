<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
</head>
<body class="bg-dark text-white" style="background-color: #0f172a;">

  <!-- Header -->
  <header class="d-flex align-items-center gap-3 px-4 py-3 shadow" style="background-color: #1e293b;">
    <button onclick="history.back()" class="btn btn-link text-white fs-4 m-0 p-0" style="text-decoration: none;">&#8592;</button>
    <h1 class="fs-4 m-0">Profile</h1>
  </header>

  <!-- Main form box -->
  <div class="container d-flex justify-content-center align-items-center min-vh-100">
    <div class="row p-4 shadow w-100" style="max-width: 900px; background-color: #1e293b; border-radius: 20px;">
      
      <!-- Profile image preview -->
      <div class="col-md-6 d-flex justify-content-center align-items-center flex-column text-center mb-4 mb-md-0">
        <div style="width: 250px; height: 250px; border-radius: 50%; border: 4px solid #3b82f6; overflow: hidden; background-color: #334155;">
          <img id="profilePreview" src="" alt="Profile Image" style="width: 100%; height: 100%; object-fit: cover; display: none;">
        </div>
        <p class="text-white mt-2">Profile Preview</p>
      </div>
      
      <!-- Form -->
      <div class="col-md-6">
        <form id="profileForm">
          <div class="mb-3">
            <input type="text" id="username" class="form-control form-control-lg text-white"
                   placeholder="Username"
                   style="background-color: #334155; border: 1px solid #475569;">
          </div>
          <div class="mb-3">
            <textarea id="bio" class="form-control form-control-lg text-white" rows="3"
                      placeholder="Your bio..."
                      style="background-color: #334155; border: 1px solid #475569;"></textarea>
          </div>
          <div class="mb-3">
            <input type="file" id="photo" class="form-control form-control-lg text-white"
                   accept="image/*"
                   style="background-color: #334155; border: 1px solid #475569;">
          </div>
          <button id="saveProfileBtn" class="btn btn-lg w-100 text-white"
                  style="background-color: #3b82f6; border: none;">Save Profile</button>
        </form>
        <div id="result" class="mt-3"></div>
      </div>
    </div>
  </div>

  <script>
    const photoInput = document.getElementById('photo');
    const previewImg = document.getElementById('profilePreview');

    photoInput.addEventListener('change', function (event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          previewImg.src = e.target.result;
          previewImg.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        previewImg.src = '';
        previewImg.style.display = 'none';
      }
    });

    document.getElementById('saveProfileBtn').addEventListener('click', async function(event) {
      event.preventDefault();

      const username = document.getElementById('username').value;
      const bio = document.getElementById('bio').value;

      if (!username || !bio) {
        alert("Please enter username and bio.");
        return;
      }

      const profileData = { username, bio };

      try {
        const response = await fetch("http://localhost:8080/profile", {
          method: "POST",
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(profileData)
        });

        const result = await response.json();
        console.log("Server response:", result);

        if (response.ok) {
          if (result.token) {
            localStorage.setItem("token", result.token);
            window.location.href = "dashboard.html";
          } else {
            alert("Error: No token received from the server.");
          }
        } else {
          alert("Error: " + result.error);
        }
      } catch (error) {
        console.error("Error:", error);
        alert("An error occurred. Please try again.");
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>